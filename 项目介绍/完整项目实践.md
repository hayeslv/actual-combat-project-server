## 项目配置

### 前端

#### 支持sass

```bash
yarn add -D sass sass-loader@10 fibers
```

#### 处理跨域：代理请求

nuxt.config.js

```js
modules: [
  '@nuxtjs/axios', // 原有的
  '@nuxtjs/proxy'
],
proxy: {
  '/api': {
    target: 'http://localhost:7001',
    secure: false,
    pathRewrite: {
      '^/api': ''
    }
  }
}
```





## 一、注册

### 1、前端：基本布局

layouts文件夹下，放的都是布局文件

**default.vue**

```vue
<template>
  <div>
    <nuxt />
  </div>
</template>

<script>
export default {
}
</script>

<style lang="scss" scoped>

</style>
```

**login.vue**

```vue
<template>
  <div>
    <el-form class="login-form" :rules="rules">
      <el-form-item props="email">
        <span> <i class="el-icon-mobile" /> </span>
        <el-input placeholder="邮箱" />
      </el-form-item>
      <el-form-item props="passwork">
        <span> <i class="el-icon-lock" /> </span>
        <el-input placeholder="密码" />
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  layout: 'login',
  data () {
    return {
      rules: []
    }
  }
}
</script>

<style lang="scss" scoped>
.login-form{
  width: 800px;
  margin: 50px auto;
}
</style>
```



### 2、图片验证码

#### server部分

```bash
npm i svg-captcha -S
```

在router.js中新增路由

```js
// 验证码
router.get('/captcha', controller.util.captcha);
```

server\app\controller\util.js

```js
'use strict';
const svgCaptcha = require('svg-captcha');
const Controller = require('egg').Controller;

class UtilController extends Controller {
  async captcha() {
    const { ctx } = this;
    const captcha = svgCaptcha.create({
      size: 4,
      fontSize: 50,
      width: 100,
      height: 40,
      noise: 3,
    });
    // 存在session中
    ctx.session.captcha = captcha.text;
    console.log('captcha =>' + captcha.text);
    ctx.response.type = 'image/svg+xml';
    ctx.body = captcha.data;
  }
}
module.exports = UtilController;
```



#### front部分

login.vue

```vue
<el-form-item props="captcha">
  <el-input placeholder="验证码" />
  <img :src="captchaUrl" alt="" @click="updateCaptcha">
</el-form-item>

data () {
  return {
    captchaUrl: '/api/captcha?_t' + new Date().getTime()
  }
},
methods: {
  updateCaptcha () {
    this.captchaUrl = '/api/captcha?_t' + new Date().getTime()
  }
}
```



### 3、注册表单

#### front部分

##### md5加密

```bash
npm i md5 -S
```



##### front\pages\register.vue

```vue
<template>
  <div class="login-container">
    <el-form ref="registerForm" label-width="100px" class="login-form" :model="form" :rules="rules">
      <div class="title-container">
        <img src="/logo.png" alt="">
      </div>
      <el-form-item prop="email" label="邮箱">
        <el-input v-model="form.email" placeholder="请输入邮箱" />
      </el-form-item>
      <el-form-item prop="captcha" label="验证码" class="captcha-container">
        <div class="captcha">
          <img :src="code.captcha" alt="" @click="resetCaptcha">
        </div>
        <el-input v-model="form.captcha" placeholder="请输入验证码" />
      </el-form-item>
      <el-form-item prop="nickname" label="昵称">
        <el-input v-model="form.nickname" placeholder="请输入昵称" />
      </el-form-item>
      <el-form-item prop="password" label="密码">
        <el-input v-model="form.password" type="password" placeholder="请输入密码" />
      </el-form-item>
      <el-form-item prop="repassword" label="确认密码">
        <el-input v-model="form.repassword" type="password" placeholder="请再次输入密码" />
      </el-form-item>
      <el-form-item label="">
        <el-button type="primary" @click.native.prevent="handlerRegister">
          注册
        </el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
import md5 from 'md5'
export default {
  layout: 'login',
  data () {
    return {
      form: {
        email: '417703683@qq.com',
        password: 'a417703683',
        repassword: 'a417703683',
        nickname: 'dylan',
        captcha: ''
      },
      rules: {
        email: [
          { required: true, message: '请输入邮箱' },
          { type: 'email', message: '请输入正确的邮箱格式' }
        ],
        captcha: [
          { required: true, message: '请输入验证码' }
        ],
        nickname: [
          { required: true, message: '请输入昵称' }
        ],
        password: [
          { required: true, pattern: /^[\w_-]{6,12}$/, message: '请输入6~12位密码' }
        ],
        repassword: [
          { required: true, pattern: /^[\w_-]{6,12}$/, message: '请再次密码' },
          {
            validator: (rule, value, callback) => {
              if (value !== this.form.password) {
                callback(new Error('两次密码不一致'))
              }
              callback()
            }
          }
        ]
      },
      code: {
        captcha: '/api/captcha'
      }
    }
  },
  methods: {
    resetCaptcha () {
      this.code.captcha = '/api/captcha?_t' + new Date().getTime()
    },
    handlerRegister () {
      this.$refs.registerForm.validate(async (valid) => {
        if (valid) {
          console.log('校验成功')
          // TODO 发送注册请求
          const params = {
            email: this.form.email,
            password: md5(this.form.password), // 注意这里实际使用时应该加盐
            nickname: this.form.nickname,
            captcha: this.form.captcha
          }
          const res = await this.$http.post('/user/register', params)
          if (res.code === 200) {
            this.$alert('注册成功', '成功', {
              confirmButtonText: '去登录',
              callback: () => {
                this.$router.push('/login')
              }
            })
          } else {
            this.$message.error(res.message)
          }
        } else {
          console.log('校验失败')
        }
      })
    }
  }
}
</script>

<style lang="scss" scoped>

</style>
```

##### front\layouts\login.vue

```vue
<template>
  <div>
    <!-- <div>导航</div> -->
    <nuxt />
    <!-- <div>底部信息</div> -->
  </div>
</template>

<script>
export default {
}
</script>

<style lang="scss">
.login-container{
  width: 100%;
  min-height: 100%;
  .login-form{
    width: 520px;
    padding: 160px 0;
    margin: 0 auto;
    overflow: hidden;
  }
  .title-container{
    text-align: center;
    img{
      width: 200px;
      margin-bottom: 20px;
    }
  }
}
</style>
```

请求封装

##### nuxt.config.js

```js
plugins: [
  '@/plugins/element-ui',
  '@/plugins/axios' // axios使用插件模式
],
```

##### front\plugins\axios.js

```js
import Vue from 'vue'
import axios from 'axios'

const service = axios.create({
  baseURL: '/api' // 走这里的请求，都有/api的前缀
})

// 请求拦截
// 主要做token管理

// 响应拦截
service.interceptors.response.use(
  (response) => {
    const { data } = response

    return data
  }
)

Vue.prototype.$http = service

export const http = service
```



#### server部分

安装插件：分别为路由管理、mongoose数据库、校验库

```bash
npm i egg-router-group egg-mongoose egg-validate -S
```

加密插件、jwt插件

```bash
npm i md5 jsonwebtoken -S
```



##### 添加控制层基类 server\app\controller\base.js

```js
// 定制规范
'use strict';

const { Controller } = require('egg');

class BaseController extends Controller {
  success(data) {
    this.ctx.body = {
      code: 200,
      data,
    };
  }
  message(message) {
    this.ctx.body = {
      code: 200,
      message,
    };
  }
  error(message, code = 500, errors = {}) {
    this.ctx.body = {
      code,
      message,
      errors,
    };
  }
}
module.exports = BaseController;
```



##### 配置插件

server\config\plugin.js

```js
exports.mongoose = {
  enable: true,
  package: 'egg-mongoose',
};
exports.routerGroup = {
  enable: true,
  package: 'egg-router-group',
};
exports.validate = {
  enable: true,
  package: 'egg-validate',
};
```



##### 在router.js中注册路由

```js
router.group({ name: 'user', prefix: '/user' }, router => {
  const { info, register, login, verify } = controller.user;

  router.post('/register', register);
  router.post('/login', login);
  router.get('/info', info);
  router.get('/verify', verify);
});
```



##### eggjs的post请求默认有scrf安全策略，这里先关掉

config/config.default.js

```js
// 这里关掉csrf：注，正式环境需要启动
security: {
  csrf: {
    enable: false,
  },
},
mongoose: {
  client: {
    url: 'mongodb://192.168.2.135:27017/kkbhub',
    options: {},
  },
},
```



##### 添加model层：用户模型

server\app\model\user.js

```js
'use strict';
module.exports = app => {
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const UserSchema = new Schema({
    email: { type: String, require: true },
    password: { type: String, require: true },
    nickname: { type: String, require: true },
    avatar: { type: String, require: false, default: '/user.png' },
  }, { timestamps: true });

  return mongoose.model('User', UserSchema);
};
```



##### 用户controller类

server\app\controller\user.js

```js
'use strict';
const md5 = require('md5');
const BaseController = require('./base');

const HashSalt = ':DylanLV@sAult~';
const createRule = {
  email: { type: 'email' },
  nickname: { type: 'string' },
  password: { type: 'string' },
  captcha: { type: 'string' },
};

class UserController extends BaseController {
  async login() {

  }
  async register() {
    const { ctx } = this;
    try {
      // 校验传递的参数：这里只做了简单的类型校验
      ctx.validate(createRule);
    } catch (e) {
      return this.error('参数校验失败', 500, e.errors);
    }

    const { email, password, captcha, nickname } = ctx.request.body;

    // 校验验证码
    if (captcha.toUpperCase() !== ctx.session.captcha.toUpperCase()) return this.error('验证码错误');
    // 邮箱是否重复
    if (await this.checkEmail(email)) return this.error('邮箱重复啦');

    const res = await ctx.model.User.create({
      email,
      nickname,
      password: md5(password + HashSalt), // 加盐加密
    });
    if (res._id) return this.message('注册成功');
  }
  async checkEmail(email) {
    const user = await this.ctx.model.User.findOne({ email });
    return user;
  }
  async verify() {
    // 校验用户名是否存在
  }
  async info() {

  }
}
module.exports = UserController;
```



## 二、登录

































